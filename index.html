<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Fahrzeugkontrolle  Schwerlast (GitHub Pages)</title>

  <!-- App-/Theme -->
  <meta name="theme-color" content="#0076BC">
  <meta name="apple-mobile-web-app-title" content="Check dein Fahrzeug">
  <meta name="color-scheme" content="light">

  <!-- Favicons / Touch-Icons -->
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%27http%3A//www.w3.org/2000/svg%27%20width%3D%27128%27%20height%3D%27128%27%20stroke%3D%27white%27%20stroke-width%3D%2710%27%20stroke-linecap%3D%27round%27%20stroke-linejoin%3D%27round%27%3E%3C/svg%3E">
  <link rel="preload" as="image" href="https://jofelbi66-rgb.github.io/Fahrzeugkontrolle/felbermayr_logo.png?v=7" crossorigin="anonymous">
  <link rel="icon" type="image/png" sizes="32x32" href="https://jofelbi66-rgb.github.io/Fahrzeugkontrolle/felbermayr_logo.png?v=7">
  <link rel="apple-touch-icon" href="https://jofelbi66-rgb.github.io/Fahrzeugkontrolle/felbermayr_logo.png?v=7">

  <style>
    :root{--b:#e2e8f0;--mut:#64748b;--ok:#059669;--warn:#d97706;--bad:#dc2626}
    *{box-sizing:border-box}
    body{margin:0;font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#f8fafc;color:#0f172a}
    header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--b);z-index:5}
    .wrap{max-width:980px;margin:0 auto;padding:14px}
    h1{margin:0;font-size:20px} h2{margin:0 0 10px;font-size:18px}
    section{background:#fff;border:1px solid var(--b);border-radius:12px;padding:14px;margin:12px 0}
    .grid{display:grid;gap:10px}
    @media(min-width:720px){.grid-2{grid-template-columns:1fr 1fr}}
    label span{font-size:14px;font-weight:600}
    input,textarea{width:100%;padding:12px;border:1px solid var(--b);border-radius:10px;font:inherit}
    textarea{min-height:56px;resize:vertical}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .btn{padding:10px 14px;border:1px solid var(--b);background:#fff;border-radius:10px;cursor:pointer;font-weight:600}
    .btn:hover{background:#f1f5f9}
    .btn.ok.active{background:var(--ok);color:#fff}
    .btn.warn.active{background:var(--warn);color:#fff}
    .btn.bad.active{background:var(--bad);color:#fff}
    .chip{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid var(--b);background:#eef2ff}
    .card{border:1px solid var(--b);border-radius:10px;padding:10px}
    .status{font-size:14px;color:#64748b}
    .photos{display:flex;gap:8px;overflow:auto}
    .ph{position:relative;width:92px;height:92px;border:1px solid var(--b);border-radius:8px;overflow:hidden;background:#f8fafc}
    .ph img{width:100%;height:100%;object-fit:cover}
    .x{position:absolute;right:4px;top:4px;width:22px;height:22px;border-radius:11px;border:1px solid var(--b);background:#fff;cursor:pointer;line-height:20px;text-align:center;font-size:14px}
    footer{position:sticky;bottom:0;background:#fff;border-top:1px solid var(--b)}
    .help{font-size:12px;color:#475569}
  </style>
</head>
<body>
  
  <!-- Logo fest vorladen (für PDF) -->
  <img id="felberLogo"
       src="https://jofelbi66-rgb.github.io/Fahrzeugkontrolle/felbermayr_logo.png?v=7"
       alt="Felbermayr Logo"
       style="display:none"
       crossorigin="anonymous">

  <header>
    <div class="wrap row" style="justify-content:space-between">
      <h1>Fahrzeugkontrolle – Schwerlast/Zugmaschine</h1>

      <!-- Zusatzkopfdaten -->
      <div class="row" id="kopfdaten-extra" style="gap: 18px; align-items: center; margin-top: 6px;">
        <fieldset style="border:0; padding:0; margin:0;">
          <legend style="font-weight:600; margin-bottom:4px;">Los *</legend>
          <label class="chip"><input type="radio" name="los" value="4.1"> 4.1</label>
          <label class="chip"><input type="radio" name="los" value="4.2"> 4.2</label>
        </fieldset>

        <fieldset style="border:0; padding:0; margin:0;">
          <legend style="font-weight:600; margin-bottom:4px;">Art des Transports *</legend>
          <label class="chip"><input type="radio" name="art" value="Lastfahrt ISA – Abspülplatz"> Lastfahrt ISA – Abspülplatz</label>
          <label class="chip"><input type="radio" name="art" value="Leerfahrt Abspülplatz – ISA"> Leerfahrt Abspülplatz – ISA</label>
          <label class="chip"><input type="radio" name="art" value="Transitfahrt ISA – ISA"> Transitfahrt ISA – ISA</label>
        </fieldset>

        <fieldset style="border:0; padding:0; margin:0;">
          <legend style="font-weight:600; margin-bottom:4px;">ISA *</legend>
          <label class="chip"><input type="radio" name="isa" value="Zeven"> Zeven</label>
          <label class="chip"><input type="radio" name="isa" value="Berkhof"> Berkhof</label>
          <label class="chip"><input type="radio" name="isa" value="Hildesheim"> Hildesheim</label>
        </fieldset>
      </div>

      <div class="row">
        <button class="btn" id="btnGeo">GPS-Ort</button>
        <button class="btn" id="btnPdf">PDF speichern</button>
        <button class="btn" id="btnMail">An Dispo (E-Mail + PDF)</button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div>
      <h2>Empfänger / Versand</h2>
      <div class="grid grid-2">
        <label><span>Dispo-E-Mail</span>
          <input id="inDispo" value="Dispo-Memmingen@felbermayr.cc" disabled>
        </label>
        <label><span>CC (optional)</span><input id="inCc" placeholder="cc@firma.de"></label>
      </div>
      <label><span>BCC (optional)</span><input id="inBcc" placeholder="bcc@firma.de"></label>
      <p class="help">Versand per Google-Relay mit PDF-Anhang. Adressen werden nur lokal gespeichert.</p>
    </div>

    <section>
      <h2>Fahrzeugdaten</h2>
      <div class="grid grid-2">
        <label><span>Datum/Uhrzeit</span><input id="inDate" type="datetime-local"></label>
        <label><span>Fahrer/in *</span><input id="inOp" placeholder="Vorname Nachname"></label>
        <label><span>Zugmaschine *</span><input id="inTr" placeholder="DN-AB 1234"></label>
        <label><span>Auflieger/Modul *</span><input id="inTl" placeholder="…"></label>
        <label class="grid-col-span-2"><span>Ort</span><input id="inLoc" placeholder="automatisch per GPS oder manuell"></label>
      </div>
      <div class="status" id="geoOut" style="margin-top:6px"></div>
    </section>

    <section>
      <h2>Logo für Bericht (optional)</h2>
      <div class="row">
        <input type="file" id="inLogo" accept="image/*">
        <span class="help">Einmal auswählen → wird klein gespeichert (PDF bleibt &lt; 200 kB).</span>
      </div>
      <div id="logoInfo" class="status"></div>
    </section>

    <section>
      <h2>Checkliste (mit Fotos)</h2>
      <div id="checklist"></div>
      <p class="status">Fotos werden stark komprimiert.</p>
    </section>

    <section>
      <h2>Unterschrift</h2>
      <div class="card" style="overflow:hidden">
        <canvas id="sig" style="touch-action:none;width:100%;height:170px;"></canvas>
      </div>
      <div class="row" style="margin-top:8px">
        <button class="btn" id="btnClearSig">Löschen</button>
        <button class="btn" id="btnSaveSig">Übernehmen</button>
        <span id="sigStatus" class="status" style="display:none;color:#047857">Gespeichert ✓</span>
      </div>
    </section>
  </main>

  <footer><div class="wrap"><div id="status" class="status">Bereit</div></div></footer>

  <!-- jsPDF -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <script>
  (function(){
    const { jsPDF } = window.jspdf;
    const $ = s => document.querySelector(s);
    const SKEY='fahrzeugkontrolle_pages_single';
    let state = JSON.parse(localStorage.getItem(SKEY) || '{}');
    state.res=state.res||{}; state.geo=state.geo||null; state.logo=state.logo||null; state.logoAspect=state.logoAspect||1; state.lockRecipients=true;

    const items = [
      {id:'h1', sec:'Hydraulik & Schläuche', title:'Hydraulik-Kupplungen verriegelt & dicht', req:1},
      {id:'h2', sec:'Hydraulik & Schläuche', title:'Schläuche ohne Scheuer-/Knickstellen', req:1},
      {id:'h3', sec:'Hydraulik & Schläuche', title:'Druck-/Funktionsprobe ohne Auffälligkeiten', req:1},
      {id:'l1', sec:'Leckagen / Austritte',  title:'Kein Ölfilm an Verbindern/Flanschen', req:1},
      {id:'l2', sec:'Leckagen / Austritte',  title:'Keine Tropfenbildung / keine Pfützen', req:1},
      {id:'f1', sec:'Fahrzeug allgemein',    title:'Beleuchtung komplett i. O.', req:1},
      {id:'f2', sec:'Fahrzeug allgemein',    title:'Reifen/Felgen i. O.', req:1},
      {id:'f3', sec:'Fahrzeug allgemein',    title:'Bremsprobe bestanden', req:1},
      {id:'f4', sec:'Fahrzeug allgemein',    title:'Ladungssicherung plausibel', req:1},
      {id:'m1', sec:'Umweltschutz',          title:'Mobile Auffangmatten vorhanden & einsatzbereit', req:1}
    ];

// --- DIAGNOSE START ---
// --- INIT nach DOMContentLoaded --------------------------------------------
window.addEventListener('DOMContentLoaded', () => {
  console.log('[INIT] DOMContentLoaded fired');

  // Buttons
  const bPdf  = document.getElementById('btnPdf');
  if (bPdf && typeof window.onPdf === 'function') {
    bPdf.addEventListener('click', window.onPdf);
  }

  const bMail = document.getElementById('btnMail');
  if (bMail && typeof window.onMail === 'function') {
    bMail.addEventListener('click', window.onMail);
  }

  const btnGeo = document.getElementById('btnGeo');
  if (btnGeo && typeof window.onGeo === 'function') {
    btnGeo.addEventListener('click', window.onGeo);
  }

  // Logo-Picker
  const inLogo = document.getElementById('inLogo');
  if (inLogo && typeof window.onLogoPick === 'function') {
    inLogo.addEventListener('change', window.onLogoPick);
  }

  // Pflicht
  if (typeof renderChecklist === 'function') renderChecklist();
  if (typeof initSignature   === 'function') initSignature();

  console.log('[INIT] abgeschlossen');
});


// -------- Signatur-Setup (MUSS vor dem DOMContentLoaded stehen) --------
function initSignature(){
  const c = document.getElementById('sig');
  if (!c) return;
  const ctx = c.getContext('2d');

  function size(){
    const w = c.clientWidth, h = 170, px = window.devicePixelRatio || 1;
    c.style.width = w + 'px';
    c.style.height = h + 'px';
    c.width  = Math.round(w * px);
    c.height = Math.round(h * px);
    ctx.setTransform(px,0,0,px,0,0);
    ctx.lineWidth = 2;
    ctx.lineCap   = 'round';
    ctx.strokeStyle = '#111827';
  }
  size();
  window.addEventListener('resize', size);

  let down=false,last=null;
  const P=e=>{const r=c.getBoundingClientRect();return{x:e.clientX-r.left,y:e.clientY-r.top}};
  c.addEventListener('pointerdown',e=>{down=true;last=P(e);});
  c.addEventListener('pointerup',  ()=>{down=false;last=null;});
  c.addEventListener('pointerleave',()=>{down=false;last=null;});
  c.addEventListener('pointermove',e=>{
    if(!down) return;
    const p=P(e);
    ctx.beginPath(); ctx.moveTo(last.x,last.y); ctx.lineTo(p.x,p.y); ctx.stroke();
    last=p;
  });

  const save=document.getElementById('btnSaveSig');
  const clr =document.getElementById('btnClearSig');
  if (clr)  clr.onclick  = ()=>{ ctx.clearRect(0,0,c.width,c.height); state.sig=''; document.getElementById('sigStatus').style.display='none'; persist(); };
  if (save) save.onclick = ()=>{ state.sig=c.toDataURL('image/png'); document.getElementById('sigStatus').style.display='inline'; persist(); };
}

// -------- PDF bauen (Zebra-Tabelle + großes weißes Signaturfeld) --------
function buildPdf() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit:'mm', format:'a4', compress:true });

  const m = 14;
  const pageW = doc.internal.pageSize.getWidth();
  const pageH = doc.internal.pageSize.getHeight();
  let y = m;

  // Logo Seite 1
  try {
    const domLogo = document.getElementById('felberLogo');
    if (domLogo && domLogo.complete) {
      const LOGO_W=32, LOGO_H=12, Y_LOGO=6, X_LOGO=pageW - m - LOGO_W;
      doc.addImage(domLogo,'PNG',X_LOGO,Y_LOGO,LOGO_W,LOGO_H);
      y = Math.max(y, Y_LOGO + LOGO_H + 8);
    }
  } catch(_) {}

  const line=(txt,bold=false)=>{ doc.setFont('helvetica', bold?'bold':'normal'); doc.text(String(txt||''), m, y); y+=6; };

  // Kopf
  line('Fahrzeugkontrolle – Schwerlast/Zugmaschine', true);
  line(`Datum/Uhrzeit: ${document.getElementById('inDate')?.value || ''}`);
  line(`Fahrer/in: ${document.getElementById('inOp')?.value || ''}`);
  line(`Zugmaschine: ${document.getElementById('inTr')?.value || ''} | Auflieger/Modul: ${document.getElementById('inTl')?.value || ''}`);
  const locVal = document.getElementById('inLoc')?.value || '';
  if (locVal) line(`Ort: ${locVal}`);
  if (state.geo) line(`Geotag: ${state.geo.lat}, ${state.geo.lon} (±${state.geo.acc} m)`);
  y += 2;

  // Tabelle
  const colW = { status:28, foto:32, text: pageW - 2*m - 28 - 32 };
  const x    = { status:m,  text: m + 28, foto: pageW - m - colW.foto };

  doc.setDrawColor(200); doc.setFillColor(245,245,245);
  doc.rect(m, y, pageW - 2*m, 8, 'F');
  doc.setFont('helvetica','bold');
  doc.text('Status',     x.status + 2, y + 5);
  doc.text('Checkpunkt', x.text   + 2, y + 5);
  doc.text('Foto',       x.foto   + 2, y + 5);
  y += 10;

  const rowHmin=8, zebraA=[255,255,255], zebraB=[248,250,252];
  let rowIndex=0;

  items.forEach(it=>{
    const r = state.res[it.id] || {};
    const sev = r.sev || '-';
    const txt = it.title + (r.note ? ('\nNotiz: ' + r.note) : '');
    const fotos = (r.photos && r.photos.length) ? `ja (${r.photos.length})` : '–';

    doc.setFont('helvetica','normal');
    const wrapped = doc.splitTextToSize(txt, colW.text - 4);
    const rowH = Math.max(rowHmin, 5 + wrapped.length*4);

// ----------------------------
// Checklisten-Ausgabe (Zebra)
// ----------------------------
rows.forEach((x, rowIndex) => {
  const bg = (rowIndex % 2 === 0) ? [255, 255, 255] : [240, 240, 240];
  doc.setFillColor(bg[0], bg[1], bg[2]);
  doc.rect(m, y - 1, pageW - 2 * m, rowH, 'F');

  // Spalteninhalte
  doc.text(`[${x.sev}]`, x.status + 2, y + 5);
  doc.text(x.textWrapped, x.text + 2, y + 5);
  doc.text(x.foto, x.foto + 2, y + 5);

  // Linien unter jeder Zeile
  doc.setDrawColor(230);
  doc.line(m, y + rowH - 1, pageW - m, y + rowH - 1);

  y += rowH + 2;
});

// ----------------------------
// Abstand zwischen Tabelle & Unterschrift
// ----------------------------
y += 20; // <-- Abstand hier anpassen (z. B. 30 für noch mehr Weißraum)


// ----------------------------
// Unterschrift
// ----------------------------
y += 4;
doc.setFont('helvetica', 'bold');
doc.text('Digitale Unterschrift:', m, y);
y += 4;

// Weißes Feld für Unterschrift zeichnen
const sigBoxW = pageW - 2 * m;
const sigBoxH = 55;
const sigX = m;
const sigY = y + 2;

doc.setFillColor(255, 255, 255);
doc.rect(sigX, sigY, sigBoxW, sigBoxH, 'F');

// Falls Unterschrift vorhanden, Bild einfügen
if (state.sig) {
  try {
    const pad = 3;
    const fmt = state.sig.startsWith('data:image/png') ? 'PNG' : 'JPEG';
    doc.addImage(state.sig, fmt, sigX + pad, sigY + pad, sigBoxW - 2 * pad, sigBoxH - 2 * pad);
  } catch {
    doc.setFont('helvetica', 'normal');
    doc.text('(keine Signatur einbettbar)', m, sigY + 6);
  }
} else {
  doc.setDrawColor(200);
  doc.rect(sigX, sigY, sigBoxW, sigBoxH);
  doc.setFont('helvetica', 'normal');
  doc.text('(keine Signatur)', m, sigY + 6);
}

// Nach der Signatur wieder etwas Abstand
y += sigBoxH + 6;
  

// ===== Fotos je Checkpunkt als Folgeseiten anfügen =====
const m2 = m; // Außenrand weiterverwenden
items.forEach(it=>{
  const r = state.res[it.id] || {};
  if (!r.photos || !r.photos.length) return;

  doc.addPage();
  let y2 = m2;

  // Überschrift
  doc.setFont('helvetica','bold');
  doc.text(`Fotos – ${it.title}`, m2, y2);
  y2 += 8;

  // Jede Aufnahme in moderater Größe einfügen
  const pageW2 = doc.internal.pageSize.getWidth();
  const pageH2 = doc.internal.pageSize.getHeight();
  const maxW  = pageW2 - 2*m2;
  const maxH  = 60; // Zielhöhe je Bild ~60 mm

  r.photos.forEach(p=>{
    try{
      // Abmessungen robust ermitteln
      let iw = 1200, ih = 900;
      try{
        const props = doc.getImageProperties(p);
        iw = props?.width  || props?.w || iw;
        ih = props?.height || props?.h || ih;
      }catch(_){}

      // Skaliert, ohne zu groß zu werden
      let scale = Math.min(maxW/iw, maxH/ih);
      scale *= 0.80; // kleine Drossel für Dateigröße
      const w = Math.max(1, iw*scale);
      const h = Math.max(1, ih*scale);

      // Seitenumbruch falls nötig
      if (y2 + h > pageH2 - m2) { doc.addPage(); y2 = m2; }

      const x2 = m2 + (maxW - w)/2;
      doc.addImage(p, 'JPEG', x2, y2, w, h);
      y2 += h + 6;
    }catch(_){
      doc.setFont('helvetica','normal');
      doc.text('(Foto konnte nicht eingebettet werden)', m2, y2);
      y2 += 8;
    }
  });
});

  // Logo auf Folgeseiten
  try {
    const domLogo = document.getElementById('felberLogo');
    if (domLogo && domLogo.complete) {
      const LOGO_W=28, LOGO_H=10.5, Y_LOGO=6, X_LOGO=pageW - m - LOGO_W;
      for(let i=2;i<=doc.getNumberOfPages();i++){ doc.setPage(i); doc.addImage(domLogo,'PNG',X_LOGO,Y_LOGO,LOGO_W,LOGO_H); }
    }
  } catch(_) {}

  return doc.output('blob');


// ------- Utilities -------
const blobToBase64 = (blob) => new Promise((res, rej) => {
  const r = new FileReader();
  r.onload  = () => res(r.result.split(',')[1]);  // <-- Komma entfernt
  r.onerror = rej;
  r.readAsDataURL(blob);
});


// -------- Aktionen --------
function onPdf(){
  try{
    const blob=buildPdf();
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='Fahrzeugkontrolle.pdf'; a.click();
    URL.revokeObjectURL(url);
    const s=document.getElementById('status'); if(s) s.textContent='PDF gespeichert ('+(blob.size/1024/1024).toFixed(2)+' MB)';
  }catch(err){ alert('PDF-Fehler: '+(err?.message||err)); }
}
window.onPdf = onPdf;
    
async function onMail(){
  try{
    const RELAY_URL='https://script.google.com/macros/s/AKfycbwNt85E1m00CkLoL2U5wI8hCK5C2Zu0SzMb4x__sw7nXkGtk1nwXnYvXsRyv8CUDlsC/exec';
    const s=document.getElementById('status'); if(s) s.textContent='Erzeuge PDF …';
    const pdfBlob=buildPdf();
    const base64=await blobToBase64(pdfBlob);

    const dt=document.getElementById('inDate')?.value || '';
    const tr=document.getElementById('inTr')?.value || 'Zug';
    const tl=document.getElementById('inTl')?.value || 'Aufl';
    const subject=`Fahrzeugkontrolle ${tr} / ${tl}`;
    const filename=`Fahrzeugkontrolle_${tr}_${tl}_${dt}.pdf`.replace(/\s+/g,' ').replace(/[^\wäöüÄÖÜß ._-]/g,'');

    const payload={
      to:'Dispo-Memmingen@felbermayr.cc',
      cc:(document.getElementById('inCc')?.value||'').trim(),
      bcc:(document.getElementById('inBcc')?.value||'').trim(),
      subject,
      text:'Fahrzeugkontrolle – Schwerlast/Zugmaschine',
      html:'<div>Fahrzeugkontrolle – Schwerlast/Zugmaschine</div>',
      filename,
      pdfBase64: base64
    };

    if(s) s.textContent='Sende über Relay …';
    await fetch(RELAY_URL, {
      method:'POST',
      mode:'no-cors',
      headers:{ 'Content-Type':'text/plain;charset=utf-8' },
      body: JSON.stringify(payload)
    });

    if(s) s.textContent='Bericht gesendet ✓';
    alert('E-Mail mit PDF-Anhang wurde gesendet.');
  }catch(err){
    const s=document.getElementById('status'); if(s) s.textContent='Senden fehlgeschlagen';
    alert('Fehler beim Versand: ' + (err?.message || err));
  }
}
    window.onMail = onMail;
    
// === CHECKLISTE + HILFSFUNKTIONEN ===
function renderChecklist(){
 window.renderChecklist = renderChecklist;

  const host = document.getElementById('checklist');
  if (!host) return;
  host.innerHTML = '';

  const groups = [...new Set(items.map(i => i.sec))];
  groups.forEach(sec=>{
    host.insertAdjacentHTML('beforeend', `<div style="font-weight:700;margin:6px 0">${sec}</div>`);
    items.filter(i=>i.sec===sec).forEach(it=>{
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `
        <div class="row" style="justify-content:space-between">
          <div class="row" style="gap:8px">
            <div style="font-weight:600">${it.title}</div>${it.req?'<span class="chip">Pflicht</span>':''}
          </div>
          <div class="row">
            <button class="btn" data-sev="OK">OK</button>
            <button class="btn" data-sev="Hinweis">Hinweis</button>
            <button class="btn" data-sev="Mangel">Mangel</button>
          </div>
        </div>
        <textarea placeholder="Bemerkung / Maßnahmen…"></textarea>
        <label style="display:block;margin-top:6px">
          <span style="font-size:14px;font-weight:600">Foto hinzufügen</span>
          <input type="file" accept="image/*" capture="environment" style="display:block;margin-top:6px">
        </label>
        <div class="photos" id="ph_${it.id}"></div>
      `;
      host.appendChild(card);

      if (!state.res[it.id]) state.res[it.id] = { sev:'', note:'', photos:[] };

      // Status-Buttons
      const btns = card.querySelectorAll('button[data-sev]');
      const mark = v=>{
        btns.forEach(b=>b.className='btn');
        btns.forEach(b=>{
          if (b.dataset.sev===v) b.className += ' ' + (v==='OK'?'ok':v==='Hinweis'?'warn':'bad') + ' active';
        });
      };
      if (state.res[it.id].sev) mark(state.res[it.id].sev);
      btns.forEach(b=>{
        b.onclick = ()=>{ state.res[it.id].sev=b.dataset.sev; mark(b.dataset.sev); localStorage.setItem(SKEY, JSON.stringify(state)); };
      });

      // Notiz
      const ta = card.querySelector('textarea');
      ta.value = state.res[it.id].note||'';
      ta.oninput = ()=>{ state.res[it.id].note = ta.value; localStorage.setItem(SKEY, JSON.stringify(state)); };

      // Foto
      const fi = card.querySelector('input[type=file]');
      fi.onchange = async e=>{
        const f = e.target.files && e.target.files[0]; if(!f) return;
        const url = await compressImageFile(f, 700, 0.42);
        state.res[it.id].photos.push(url);
        redrawPhotos(it.id);
        localStorage.setItem(SKEY, JSON.stringify(state));
        fi.value = '';
      };

      redrawPhotos(it.id);
    });
  });
}

function redrawPhotos(id){
  const bar = document.getElementById('ph_'+id);
  if (!bar) return;
  bar.innerHTML = '';
  (state.res[id].photos||[]).forEach((p,idx)=>{
    const d = document.createElement('div'); d.className='ph';
    d.innerHTML = `<img src="${p}"><button class="x" title="Entfernen">×</button>`;
    d.querySelector('.x').onclick = ()=>{
      state.res[id].photos.splice(idx,1);
      localStorage.setItem(SKEY, JSON.stringify(state));
      redrawPhotos(id);
    };
    bar.appendChild(d);
  });
}

// Bilder komprimieren
function compressImageFile(file,maxDim=700,quality=0.42){
  return new Promise((resolve,reject)=>{
    const r=new FileReader();
    r.onload=()=>{ const img=new Image(); img.onload=()=>{
      const c=document.createElement('canvas');
      let w=img.width,h=img.height; const s=Math.min(1,maxDim/Math.max(w,h));
      w=Math.round(w*s); h=Math.round(h*s); c.width=w; c.height=h;
      c.getContext('2d').drawImage(img,0,0,w,h);
      resolve(c.toDataURL('image/jpeg',quality));
    }; img.src=r.result; }; r.onerror=reject; r.readAsDataURL(file);
  });
}
function probeImage(dataUrl){ return new Promise(res=>{ const i=new Image(); i.onload=()=>res({w:i.width,h:i.height}); i.src=dataUrl; }); }

// === SIGNATUR ===
function initSignature(){
  const c = document.getElementById('sig');
  if (!c) return;
  const ctx = c.getContext('2d');

  function size(){
    const w=c.clientWidth,h=170,px=window.devicePixelRatio||1;
    c.style.width=w+'px'; c.style.height=h+'px';
    c.width=Math.round(w*px); c.height=Math.round(h*px);
    ctx.setTransform(px,0,0,px,0,0);
    ctx.lineWidth=2; ctx.lineCap='round'; ctx.strokeStyle='#111827';
  }
  size(); window.addEventListener('resize', size);

  let down=false,last=null;
  const P=e=>{const r=c.getBoundingClientRect(); return {x:e.clientX-r.left,y:e.clientY-r.top};};
  c.addEventListener('pointerdown',e=>{down=true; last=P(e);});
  c.addEventListener('pointerup',   ()=>{down=false; last=null;});
  c.addEventListener('pointerleave',()=>{down=false; last=null;});
  c.addEventListener('pointermove', e=>{ if(!down) return; const p=P(e); ctx.beginPath(); ctx.moveTo(last.x,last.y); ctx.lineTo(p.x,p.y); ctx.stroke(); last=p; });

  const save=document.getElementById('btnSaveSig');
  const clr =document.getElementById('btnClearSig');
  if (clr)  clr.onclick  = ()=>{ ctx.clearRect(0,0,c.width,c.height); state.sig=''; document.getElementById('sigStatus').style.display='none'; localStorage.setItem(SKEY, JSON.stringify(state)); };
  if (save) save.onclick = ()=>{ state.sig=c.toDataURL('image/png'); document.getElementById('sigStatus').style.display='inline'; localStorage.setItem(SKEY, JSON.stringify(state)); };
}
// --- GPS-Ortung + Reverse-Geocoding (für #btnGeo) ---
async function onGeo(){
  if (!navigator.geolocation) { alert('Kein GPS verfügbar.'); return; }

  navigator.geolocation.getCurrentPosition(async pos => {
    // Werte in Ihren globalen Zustand schreiben
    state.geo = {
      lat: +pos.coords.latitude.toFixed(6),
      lon: +pos.coords.longitude.toFixed(6),
      acc: Math.round(pos.coords.accuracy)
    };

    // Ausgabe unter "Fahrzeugdaten"
    const out = document.getElementById('geoOut');
    if (out) out.textContent = `${state.geo.lat}, ${state.geo.lon} (±${state.geo.acc} m)`;

    // Ortsname via Nominatim (best effort)
    try {
      const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${state.geo.lat}&lon=${state.geo.lon}&zoom=10&addressdetails=1`;
      const r = await fetch(url, { headers: { 'Accept':'application/json' } });
      const d = await r.json(); const a = d.address || {};
      const place = a.city || a.town || a.village || a.municipality || a.county || '';
      if (place) {
        const inLoc = document.getElementById('inLoc');
        if (inLoc) inLoc.value = place;
        state.inLoc = place;
        localStorage.setItem(SKEY, JSON.stringify(state));
      }
    } catch(_) { /* egal – Koordinaten stehen ja schon */ }
  }, err => {
    alert('GPS fehlgeschlagen: ' + (err?.message || err));
  });
}
// --- GLOBAL: GPS-Ortung + Reverse-Geocoding ---
window.onGeo = async function onGeo(){
  if (!navigator.geolocation) { alert('Kein GPS verfügbar.'); return; }

  navigator.geolocation.getCurrentPosition(async pos => {
    state.geo = {
      lat: +pos.coords.latitude.toFixed(6),
      lon: +pos.coords.longitude.toFixed(6),
      acc: Math.round(pos.coords.accuracy)
    };

    const out = document.getElementById('geoOut');
    if (out) out.textContent = `${state.geo.lat}, ${state.geo.lon} (±${state.geo.acc} m)`;

    try {
      const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${state.geo.lat}&lon=${state.geo.lon}&zoom=10&addressdetails=1`;
      const r = await fetch(url, { headers:{ 'Accept':'application/json' } });
      const d = await r.json(); const a = d.address || {};
      const place = a.city || a.town || a.village || a.municipality || a.county || '';
      if (place) {
        const inLoc = document.getElementById('inLoc');
        if (inLoc) inLoc.value = place;
        state.inLoc = place;
        localStorage.setItem(SKEY, JSON.stringify(state));
      }
    } catch(_) {}
  }, err => alert('GPS fehlgeschlagen: ' + (err?.message || err)));
};
 })();
            
    </script>
<!-- >> START (einziger Script-Block) -->
  <script>
(function () {
  'use strict';

  // === GLOBAL: Logo wählen/komprimieren ==============================
  window.onLogoPick = async function onLogoPick(e){
    const f = e.target.files && e.target.files[0];
    if (!f) return;

    const data = await compressImageFile(f, 320, 0.8); // deine Helper
    const info = await probeImage(data);               // deine Helper

    state.logo  = data;
    state.logoAspect = info.w / info.h || 1;

    const li = document.getElementById('logoInfo');
    if (li) li.textContent = `Logo gespeichert (${info.w}×${info.h})`;
    localStorage.setItem(SKEY, JSON.stringify(state));
  };

  // === INIT nach DOMContentLoaded ===================================
  window.addEventListener('DOMContentLoaded', () => {
    // Buttons
    const bPdf  = document.getElementById('btnPdf');
    if (bPdf)  bPdf.addEventListener('click', window.onPdf);

    const bMail = document.getElementById('btnMail');
    if (bMail) bMail.addEventListener('click', window.onMail);

    const bGeo  = document.getElementById('btnGeo');
    if (bGeo && typeof window.onGeo === 'function') {
      bGeo.addEventListener('click', window.onGeo);
    }

    // Logo-Picker
    const inLogo = document.getElementById('inLogo');
    if (inLogo && typeof window.onLogoPick === 'function') {
      inLogo.addEventListener('change', window.onLogoPick);
    }

    // Pflicht: Checkliste & Signatur
    window.renderChecklist();
    initSignature();
  });

  // === Optionaler PDF-Hook (kann leer bleiben) =======================
  window.patchPdf = function (doc, m, y) {
    try {
      /* reserviert */
    } catch (e) {
      console.warn('patchPdf warn:', e);
    }
  };

})(); // IIFE schließen
</script>
<!-- << END Script-Block -->
